<!doctype html>
<html>
<head>
    <title>lateral player</title>
    <script type="text/javascript" src="/public/js/lib.js"></script>
    <script type="text/javascript" src="/public/js/xing.js"></script>
    <script type="text/javascript" src="/public/js/id3v2.js"></script>
    <script type="text/javascript" src="/public/js/main.js"></script>
</head>
<body>
hello world
<script>
    var enc = new TextEncoder();
    class Player {
        constructor() {
            this.tracks = [];
            this.playing = false;
            
        }
        addTrack(trackUrl) {
            this.tracks.push({
                url:trackUrl
            });
        }
    }

    class Track {
        constructor(url) {
            this.url = url;
            this.loader = new XMLHttpRequest();
            this.chunks = [];
            this.audioContext = null;
        }

        async load() {
            this.loader.open("GET", this.url);
            this.loader.responseType = "arraybuffer";
            this.loader.onprogress = async (ev) => {
                if(!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.bufferSourceNode = this.audioContext.createBufferSource();
                    this.gainNode = this.audioContext.createGain();
                    this.bufferSourceNode.connect(this.gainNode);
                    this.gainNode.connect(this.audioContext.destination);
                    /*let audioBuffer = await this.audioContext.decodeAudioData(enc.encode(this.loader.response).buffer);
                    this.bufferSourceNode.buffer = audioBuffer;
                    this.bufferSourceNode.start(0);
                    */
                    //var mp3Tags = mp3Parser.readTags(new DataView(enc.encode(this.loader.response).buffer));
                    //console.log(mp3Tags);
                }
            }
            this.loader.onload = async (ev) => {
                let audioBuffer = await this.audioContext.decodeAudioData(this.loader.response);
                let channels = [];
                for(var i=0;i<audioBuffer.numberOfChannels;i++) {
                    channels.push(audioBuffer.getChannelData(i));
                }
                let combined = combineChannels(channels);
                transferPCM(combined);
            }
            this.loader.send();
        }
    }

    function getChannels(audioBuffer) {}

    function combineChannels(channelArray) {
        let combined = new Float32Array(channelArray[0].length*channelArray.length);
        for(var i=0;i<channelArray[0].length;i++) {
            for(var j=0;j<channelArray.length;j++) {
                combined[(i*2)+j] = channelArray[j][i];
            }
            
        }
        return combined;
    }

    let foo = new Track("/public/uploads/1.mp3");
</script>
</body>
</html>